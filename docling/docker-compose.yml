services:
  init-permissions:
    image: busybox:latest
    user: root
    volumes:
      - ${MODEL_CACHE}:/mnt/model_cache
    command: >
      sh -c "mkdir -p /mnt/model_cache && 
             chown -R 1001:1001 /mnt/model_cache && 
             chmod -R 775 /mnt/model_cache"
  docling-serve:
    image: quay.io/docling-project/docling-serve:${IMAGE_TAG}
    container_name: docling-serve
    restart: unless-stopped
    # æ ¸å¿ƒä¼˜åŒ–ï¼šé˜²æ­¢ AI æ¨ç†å´©æºƒ
    shm_size: '2gb'
    init: true
    ports:
      - "${HOST_PORT}:5001"
    environment:
      - DOCLING_SERVE_OCR_ENGINE=${DOCLING_SERVE_OCR_ENGINE:-easyocr}
      - DOCLING_SERVE_HOST=0.0.0.0
      - DOCLING_SERVE_PORT=5001
      - OMP_NUM_THREADS=${CPU_LIMIT}

      # ğŸ‘‡ æ–°å¢ï¼šå¼ºåˆ¶å¼€å¯å…¬å¼è¯†åˆ«å’Œ OCR
      - DOCLING_SERVE_DO_FORMULA_ENRICHMENT=true
      - DOCLING_SERVE_DO_OCR=true

      # 2. å…³é”®ï¼šè¦†ç›–é•œåƒé»˜è®¤çš„èµ„äº§è·¯å¾„ï¼Œè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œå¼ºåˆ¶å®ƒä»ç½‘ä¸Šä¸‹è½½
      - DOCLING_SERVE_ARTIFACTS_PATH=

    volumes:
      - ${MODEL_CACHE}:/opt/app-root/src/.cache


    # ğŸ‘‡ å…³é”®ï¼šåŠ å…¥ Dify çš„ç½‘ç»œï¼Œå¹¶è®¾ç½®åˆ«å
    networks:
      dify_net:
        aliases:
          - docling  # â† è¿™æ · Dify å°±èƒ½ç”¨ http://docling:5001 è®¿é—®
    

    # èµ„æºç®¡ç†ä¸ GPU è°ƒåº¦
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-8G}
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-all} # å¦‚æœè®¾ç½®ä¸º 0ï¼Œåˆ™ä¸ä¼šè¯·æ±‚ GPU
              capabilities: [gpu]
    # å¥åº·æ£€æŸ¥ï¼šç¡®ä¿ OCR æ¨¡å‹åŠ è½½å®ŒæˆåæœåŠ¡æ‰æ ‡è®°ä¸ºå¥åº·
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${HOST_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

    # ç”Ÿäº§çº§å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–
    ulimits:
      memlock: -1
      stack: 67108864

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

# ğŸ‘‡ å®šä¹‰å¤–éƒ¨ç½‘ç»œ
networks:
  dify_net:
    external: true
    name: docker_default  # â† å¿…é¡»å’Œä½ æŸ¥åˆ°çš„ç½‘ç»œåä¸€è‡´ï¼