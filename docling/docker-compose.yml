services:
  docling-serve:
    image: quay.io/docling-project/docling-serve:${IMAGE_TAG}
    container_name: docling-serve
    restart: unless-stopped
    # æ ¸å¿ƒä¼˜åŒ–ï¼šé˜²æ­¢ AI æ¨ç†å´©æºƒ
    shm_size: '2gb'
    init: true
    ports:
      - "${HOST_PORT}:5001"
    environment:
      - DOCLING_SERVE_OCR_ENGINE=${DOCLING_SERVE_OCR_ENGINE:-easyocr}
      - DOCLING_SERVE_HOST=0.0.0.0
      - DOCLING_SERVE_PORT=5001
      - OMP_NUM_THREADS=${CPU_LIMIT}
    volumes:
      - ${UPLOAD_DIR}:/uploads
      - ${LOG_DIR}:/var/log/docling
      - ${MODEL_CACHE}:/root/.cache

    # ğŸ‘‡ å…³é”®ï¼šåŠ å…¥ Dify çš„ç½‘ç»œï¼Œå¹¶è®¾ç½®åˆ«å
    networks:
      dify_net:
        aliases:
          - docling  # â† è¿™æ · Dify å°±èƒ½ç”¨ http://docling:5001 è®¿é—®

    # èµ„æºç®¡ç†ä¸ GPU è°ƒåº¦
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-8G}
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-all} # å¦‚æœè®¾ç½®ä¸º 0ï¼Œåˆ™ä¸ä¼šè¯·æ±‚ GPU
              capabilities: [gpu]
    # å¥åº·æ£€æŸ¥ï¼šç¡®ä¿ OCR æ¨¡å‹åŠ è½½å®ŒæˆåæœåŠ¡æ‰æ ‡è®°ä¸ºå¥åº·
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${HOST_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    # ç”Ÿäº§çº§å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–
    ulimits:
      memlock: -1
      stack: 67108864

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

# ğŸ‘‡ å®šä¹‰å¤–éƒ¨ç½‘ç»œ
networks:
  dify_net:
    external: true
    name: docker_default  # â† å¿…é¡»å’Œä½ æŸ¥åˆ°çš„ç½‘ç»œåä¸€è‡´ï¼